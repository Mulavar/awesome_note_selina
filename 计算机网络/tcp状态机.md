三次握手

四次挥手



常见问题

为什么是三次握手，两次行不行？

[RFC 793 - Transmission Control Protocol](https://tools.ietf.org/html/rfc793) 文档中非常清楚地定义了 TCP 中的连接是什么，我们简单总结一下：**用于保证可靠性和流控制机制的信息，包括 Socket、序列号以及窗口大小叫做连接**。

问题转变成 **为什么需要通过三次握手才可以初始化 Sockets、窗口大小和初始序列号？**

1. 阻止重复历史连接的初始化

    如果只有两次握手，server 收到的连接可能是一次过期连接，但 server 无法分辨是否是过期的历史连接，只能选择接受和拒绝 client 发起的这次连接请求。

    三次握手则是将这次连接是否建立的控制权还给了发送方，在第三次握手的过程中根据 client 发送的信息，server 才会确定是否建立连接。

2. 初始化序列号

    通信双方都需要获得一个用于发送信息的初始化序列号



TIME_WAIT 作用

关闭连接的操作其实是告诉通信的另一方**自己没有需要发送的数据**，但是它仍然**保持了接收对方数据的能力**。

client 在从 TIME_WAIT 状态到 CLOSED 的过程中需要等待**两个最大数据段生命周期**（Maximum segment lifetime，MSL）。

1. 防止延迟的数据段被其他使用相同源地址、源端口、目的地址以及目的端口的 TCP 连接收到。

2. 确保 server 能够成功关闭（client 回复 ACK 后，该消息可能丢失，此时需要 server 重新发送 FIN 消息）


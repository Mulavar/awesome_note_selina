## gcc编译步骤

gcc编译器的编译步骤实际分为四步：

- 预处理（预编译）
- 编译为汇编代码
- 将汇编代码编译成目标文件
- 链接



### 预处理（预编译）

主要处理源代码文件中以 “#” 开始的预编译指令。如 `#include`、 `#define`、 `ifdef`、`#elif`等，得到文件后缀为**.i**。

`gcc -E hello.c -o hello.i`



### 编译

把预处理完后的文件进行一系列词法、语法、语义分析及优化后生成相应汇编代码文件，得到文件后缀为**.s**。

`gcc –S hello.i –o hello.s`



### 汇编

将汇编代码翻译成机器代码，输出**目标文件**，**.o**。



### 链接

将**目标文件**和**库文件**链接得到可执行文件。

库文件分为两大类分别是**动态链接库（通常以.so结尾）**和**静态链接库（通常以.a结尾）**，二者的区别仅在于程序执行时所需的代码是在**运行时动态加载的，还是在编译时静态加载的**。

#### 例子

![image-20190813184520246](../resource/链接阶段例子.png)



编译目标文件到机器码的时候一开始不知道var变量的目标地址，就设置为0，链接的时候确定后修改为真正的地址。这个地址修正也叫**重定位**。



## 目标文件

### 目标文件的格式

 **目标文件** 的格式和 **可执行文件** 的格式几乎一样，所以可认为是同一种类型的文件，在Linux下统称 **ELF可执行文件**。

采用 **ELF格式** 的文件可归为4类，我们在开发过程中经常接触的是前面3类（可使用 `file <filename>` 查看对应的文件类型）。

| ELF文件类型                        | 说明                                                         | 实例                          |
| ---------------------------------- | ------------------------------------------------------------ | ----------------------------- |
| 可重定位文件（relocatable file）   | 包含代码和数据，可用来链接成动态共享库或可执行文件，**静态链接库**也归为这一类 | Linux的.o<br />Windows的.obj  |
| 可执行文件（executable file）      | 直接可以执行的程序                                           | /bin/bash<br />Windows的.exe  |
| 共享目标文件（shared object file） | 包含了代码和数据，即动态链接库                               | Linux的.so<br />Windows的.dll |

在目标文件的文件头中分别用以下标识确定

![image-20190813195019806](../../resource/目标文件类型.png)



### 目标文件的结构

**主体** 最常用的有三个段：

- 代码段（ .code/.text）：用于存储代码指令
- 数据段（ .data ）：用于存储已初始化的全局变量或局部静态变量
- .bss段：用于存储未初始化的全局变量和局部静态变量（只是预留位置，没有内容也不占据空间）



其余常见的段如表

![image-20190813194720898](../../resource/目标文件段.png)



代码与指令分离的优势：

- 分别设置权限，加强安全性（代码段只读，数据段读写）
- 方便发挥空间局部性，增加缓存命中率（缓存分为指令和数据两类）
- 可共享代码段，节省空间





### 常见命令及参数选项

AR：静态库打包命令

AS：汇编器打包命令

LD：链接器打包命令

- **CFLAGS**
  
    - `-c`  .o 对象文件,不进行链接过程
    - `-Idir` 用于把（.h）新目录添加到include路径上，可以使用相对和绝对路径，`-I.、-I./include、-I/opt/include`
    - `-fPIC` 用于生成位置无关的代码，不使用绝对路径
- **LDFLAGS**
  
    - `-LDir` 用于把新目录添加到库搜索路径上，可以使用相对和绝对路径，`-L.、-L./include、-L/opt/include`
    - `-llibrary` 链接时在**标准搜索目录中**寻找库文件，搜索名为`liblibrary.a` 或 `liblibrary.so`
    - `-Wa,option` 把选项 `option` 传递给汇编程序，如果 `option` 中含有逗号,就在逗号处分割成多个选项
    - `-Wl,option` 把选项 `option` 传递给**链接器**，如果 `option` 中含有逗号,就在逗号处分割成多个选项
        - `--whole-archive` 将后跟的库的符号全部加载到链接表中
    
    